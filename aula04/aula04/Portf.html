require("dotenv").config();
const express = require("express");
const mysql = require("mysql2");
const cors = require("cors");

const app = express();

app.use(cors());
app.use(express.json());

// ==================== ENV ====================
const {
  DB_HOST,
  DB_USER,
  DB_PASSWORD,
  DB_NAME,
  DB_PORT,
  DB_SSL,
  PORT,
} = process.env;

function parseBool(v) {
  if (v === undefined || v === null) return false;
  return ["true", "1", "yes", "y", "sim", "verdadeiro"].includes(
    String(v).trim().toLowerCase()
  );
}

const useSSL = parseBool(DB_SSL);
const dbPort = Number(DB_PORT || 3306);

let pool = null;

// ==================== MYSQL (POOL) ====================
async function initDB() {
  if (!DB_HOST || !DB_USER || !DB_PASSWORD || !DB_NAME) {
    console.warn("âš ï¸ MySQL nÃ£o configurado. Verifique seu arquivo .env");
    return;
  }

  pool = mysql
    .createPool({
      host: DB_HOST,
      user: DB_USER,
      password: DB_PASSWORD,
      database: DB_NAME,
      port: dbPort,
      waitForConnections: true,
      connectionLimit: 10,
      queueLimit: 0,

      // ajuda estabilidade em conexÃ£o remota
      enableKeepAlive: true,
      keepAliveInitialDelay: 0,

      // SSL somente se DB_SSL=true
      ...(useSSL ? { ssl: { rejectUnauthorized: false } } : {}),
    })
    .promise();

  try {
    await pool.query("SELECT 1");
    console.log("âœ… Conectado ao MySQL!");

    await pool.query(`
      CREATE TABLE IF NOT EXISTS contatos (
        id INT AUTO_INCREMENT PRIMARY KEY,
        nome VARCHAR(255) NOT NULL,
        email VARCHAR(255) NOT NULL,
        mensagem TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      );
    `);

    console.log("âœ… Tabela 'contatos' pronta!");
  } catch (err) {
    console.error("âŒ Erro ao conectar no MySQL:", err.message);
    pool = null;
  }
}

initDB();

// ==================== ROTAS ====================
app.get("/", (req, res) => {
  res.status(200).send("Servidor rodando ðŸš€");
});

app.post("/contato", async (req, res) => {
  const { nome, email, mensagem } = req.body;

  if (!nome || !email || !mensagem) {
    return res.status(400).json({ mensagem: "Preencha todos os campos!" });
  }

  if (!pool) {
    return res.status(500).json({
      mensagem:
        "Banco ainda nÃ£o conectado. Verifique DB_HOST/DB_USER/DB_PASSWORD/DB_NAME/DB_PORT/DB_SSL no .env",
    });
  }

  try {
    const sql = "INSERT INTO contatos (nome, email, mensagem) VALUES (?, ?, ?)";
    await pool.query(sql, [nome, email, mensagem]);
    return res.json({ mensagem: "Mensagem enviada com sucesso!" });
  } catch (err) {
    console.error("âŒ Erro no INSERT:", err.message);
    return res.status(500).json({ mensagem: "Erro ao salvar no banco" });
  }
});

// ==================== SERVIDOR ====================
const port = Number(PORT || 3000);
app.listen(port, () => {
  console.log(`Servidor rodando na porta ${port}`);
});
